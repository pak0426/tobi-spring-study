## 6.8 트랜잭션 지원 테스트

### 6.8.1 선언적 트랜잭션과 트랜잭션 전파 속성

트랜잭션을 정의할 때 지정할 수 있는 트랜잭션 전파 속성은 매우 유용한 개념이다. 예를 들어 `REQUIRED`로 전파 속성을 지정해줄 경우, 앞에서 진행 중인 트랜잭션이 있으면 참여하고 없으면 자동으로 새로운 트랜잭션을 시작해준다. `REQUIRED` 전파 속성을 가진 메서드를 결합해서 다양한 크기의 트랜잭션 작업을 만들 수 있다. 트랜잭션 적용 때문에 불필요하게 코드를 중복하는 것도 피할 수 있으며, 애플리케이션을 작은 기능 단위로 쪼개서 개발할 수 있다. 

예를 들어 사용자 등록 로직을 담당하는 `UserService`의 add() 메서드를 생각해보자. add() 메서드는 트랜잭션 속성이 디폴트로 지정되어 있으므로 트랜잭션 전파 방식은 `REQUIRED`다. 만약 add() 메서드가 처음 호출되는 서비스 계층의 메서드라면 한 명의 사용자를 등록하는 것이 하나의 비즈니스 작업 단위가 된다. 이때는 add() 메서드가 실행되기 전에 트랜잭션이 시작되고 add() 메서드를 빠져나오면 트랜잭션이 종료되는 것이 맞다. DB 트랜잭션은 단위 업무와 일치해야 하기 때문이다.

그런데 작업 단위가 다른 비즈니스 로직이 있을 수 있다. 예를 들어 그날의 이벤트의 신청 내역을 모아서 한 번에 처리하는 기능이 있다고 해보자. 처리되지 않은 이벤트 신청정보를 모두 가져와 DB에 등록하고 그에 따른 정보를 조작해주는 기능이다. 그런데 신청정보의 회원가입 항목이 체크되어 있는 경우에는 이벤트 참가자를 자동으로 사용자로 등록해줘야 한다. 하루치 이벤트 신청 내역을 처리하는 기능은 반드시 하나의 작업 단위로 처리돼야 한다. 이 기능을 `EventService` 클래스의 processDailyEventRegistration() 메서드로 구현했다고 한다면, 이 메서드가 비즈니스 트랜잭션의 경계가 된다. 그런데 processDailyEventRegistration() 메서드는 작업 중간에 사용자 등록을 할 필요가 있다. 직접 UserDao의 add() 메서드를 사용할 수도 있지만, 그보다는 `UserService`의 add() 메서드를 이용해서 사용자 등록 중 처리해야 할, 디폴트 레벨 설정과 같은 로직을 적용하는 것이 바람직하다. 

이때 `UserService`의 add() 메서드는 독자적인 트랜잭션을 시작하는 대신 processDailyEventRegistration() 메서드에서 시작된 트랜잭션의 일부로 참여하게 된다. 만약 add() 메서드 호출 뒤에 processDailyEventRegistration() 메서드를 종료하지 못하고 예외가 발생한 경우에는 트랜잭션이 롤백되면서 `UserService`의 add() 메서드에서 등록한 사용자 정보도 취소된다.

트랜잭션 전파라는 기법을 사용했기 때문에 `UserService`의 add()는 독자적인 트랜잭션 단위가 될 수도 있고, 다른 트랜잭션의 일부로 참여할 수도 있다. 트랜잭션의 전파 방식을 이용할 수 없었다면 어떻게 될까? 그렇다면 `UserService`의 add() 메서드는 매번 트랜잭션을 시작하도록 만들어졌을 것이고, 이 때문에 processDailyEventRegistration() 등의 메서드에서 호출해서 사용할 수 없었을 것이다. processDailyEventRegistration()에서 사용자 등록 기능이 필요하긴 하지만 사용자 등록 작업도 같은 트랜잭션에 넣어야 하는데 add() 메서드는 독자적인 트랜잭션을 만들기 때문이다. 그래서 어쩔 수 없이 processDailyEventRegistration() 안에 add() 메서드의 코드를 그대로 복사해서 사용하게 될 것이다.

다행히 스프링은 트랜잭션 전파 속성을 선언적으로 적용할 수 있는 기능을 제공하기 때문에 이런 고민을 할 필요는 없다. 그렇다고 트랜잭션 전파 속성이 개발자의 부주의나 게으름으로 인해 발생하는 불필요한 코드 중복을 막아주지는 못한다.

아래 그림은 add() 메서드에 `REQUIRED` 방식의 트랜잭션 전파 속성을 지정했을 때 트랜잭션이 시작되고 종료되는 경계를 보여준다.

<img width="579" alt="image" src="https://github.com/user-attachments/assets/a62d46ba-75f9-4345-b335-fdfb658baa9a">

AOP를 이용해 코드 외부에서 트랜잭션 기능을 부여해주고 속성을 지정할 수 있게 하는 방법을 **선언적 트랜잭션**이라고 한다. 반대로 `TransactionTemplate` 이나 개별 데이터 기술의 트랜잭션 API를 사용해 직접 코드 안에서 사용하는 방법은 **프로그램에 의한 트랜잭션**이라고 한다. 스프링은 이 두 가지 방법을 모두 지원하고 있다. 물론 특별한 경우가 아니라면 선언적 방식의 트랜잭션을 사용하는 것이 바람직하다.